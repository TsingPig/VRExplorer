name: Sync Folder to New Repo

on:
  push:
    paths:
      - 'Assets/VRExplorer/**'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no changes detected'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0   # 保证完整历史

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Push subtree history
        run: |
          set -euo pipefail

          FOLDER_PATH="Assets/VRExplorer"
          NEW_REPO="VRExplorer_Release"
          NEW_REPO_URL="https://${{ secrets.GH_PAT }}@github.com/${{ github.repository_owner }}/$NEW_REPO.git"

          # 如果是手动触发且未启用 force_sync，检查是否有实际更改
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.force_sync }}" = "false" ]; then
            echo "::notice::Manual trigger detected, checking folder changes..."
            if git diff --quiet HEAD^ -- "$FOLDER_PATH"; then
              echo "::warning::No changes detected in $FOLDER_PATH, skipping sync."
              exit 0
            fi
          fi

          # 生成 subtree 分支（只包含 FOLDER_PATH 的历史）
          git subtree split --prefix="$FOLDER_PATH" -b sync-branch

          # 推送到子仓库 main 分支（保留历史）
          git push "$NEW_REPO_URL" sync-branch:main

          # 推送所有标签（避免丢失 tag）
          git push "$NEW_REPO_URL" --tags

          echo "::notice::Successfully synced subtree ($FOLDER_PATH) + tags to $NEW_REPO_URL"
