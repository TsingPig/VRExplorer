name: Sync VRExplorer to VRExplorer_Release Repo

on:
  push:
    paths:
      - 'Assets/VRExplorer/**'
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 允许推送更改

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史记录

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Authenticate with Personal Access Token
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.GH_PAT }}@github.com/TsingPig/VRExplorer.git

      - name: Fetch All Branches
        run: |
          git fetch --all

      - name: Prepare VRExplorer_Release Repository
        run: |
          # 如果 VRExplorer_Release 仓库不存在，创建它
          REPO_URL="https://github.com/TsingPig/VRExplorer_Release.git"
          git ls-remote --exit-code --heads $REPO_URL || git clone $REPO_URL VRExplorer_Release
          cd VRExplorer_Release
          git checkout main || git checkout -b main  # 如果仓库中没有 main 分支则创建它

      - name: Copy Changed Files from VRExplorer to VRExplorer_Release
        run: |
          cd ..
          # 将 VRExplorer 的变更文件复制到 VRExplorer_Release 中
          rsync -av --exclude='.git' Assets/VRExplorer/ VRExplorer_Release/

      - name: Commit Changes to VRExplorer_Release
        run: |
          cd VRExplorer_Release
          # 检查是否有文件变化
          git diff --exit-code || (
            git add .
            git commit -m "Sync VRExplorer contents from main"
            git push origin main
          )
